SUBDIRS+= apxhefi

ifeq (@MACHINE@,amd64)
ARCH=x86_64
endif

ifeq (@MACHINE@,i386)
ARCH=ia32
endif

EFISRC		= $(SRCROOT)../contrib/gnu-efi
EFIINC		= $(EFISRC)/inc
EFIINCS         = -I$(EFIINC) -I$(EFIINC)/$(ARCH) -I$(EFIINC)/protocol
EFILIB          = $(EFISRC)
EFI_CRT_OBJS    = $(EFILIB)/gnuefi/crt0-efi-$(ARCH).o
EFI_LDS         = $(EFISRC)/gnuefi/elf_$(ARCH)_efi.lds

CFLAGS          = $(EFIINCS) -fno-stack-protector -fPIC \
		  -fshort-wchar -mno-red-zone -Wall -nostdinc -ffreestanding -fno-builtin 

ifeq ($(ARCH),x86_64)
  CFLAGS += -DEFI_FUNCTION_WRAPPER
endif

LDFLAGS         = -nostdlib -znocombreloc -T $(EFI_LDS) -shared \
		  -Bsymbolic -L $(EFILIB)/gnuefi -L $(EFILIB)/lib $(EFI_CRT_OBJS)

EFIOBJS 	= efi-main.o
EFITARGET	= apxh.efi

gnu-efi:
	$(MAKE) -C $(EFISRC) OBJDIR=$(EFISRC)/@MACHINE@ CFLAGS=-I../../include

apxh.so: $(EFIOBJS)  subdirs
	$(LD) $(LDFLAGS) --start-group $(EFIOBJS) apxhefi/apxhefi.apxh_main.o -lefi -lgnuefi --end-group -o $@


%.efi: %.so
	objcopy -j .text* -j .sdata -j .data -j .dynamic \
		-j .dynsym  -j .rel -j .rela -j .reloc \
		--target=efi-app-$(ARCH) $^ $@

.PHONY: clean_efi
clean_efi:
	-rm *.o *.so *.efi

ALL_TARGET	+= gnu-efi apxh.efi
CLEAN_TARGET	+= clean_efi
