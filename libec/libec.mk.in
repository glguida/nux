#
# EC - An embedded non standard C library
#
# To embed libec in your target, include this file,
# and add $(EC_SRCS) to your sources.
#
# SPDX-License-Identifier:	BSD-2-Clause
#

ifeq (z$(EC_MACHINE),z)
EC_MACHINE=@MACHINE@
endif

EC_DIR=$(SRCROOT)/@ECDIR@

EC_ARCH_DIR= $(EC_MACHINE)

include $(EC_DIR)/ec_sources.mk

# Used for crt* asm files
%.o: $(EC_DIR)/$(EC_ARCH_DIR)/%.S
	$(CC) -c $(CPPFLAGS) $(ASFLAGS) $< -o $@

LDADD_START+= crti.o crtbegin.o
LDADD_END+= crtn.o crtend.o
LDADD+= -lgcc

SRCS+= $(addprefix $(EC_DIR)/,$(EC_SRCS))
ALL_TARGET+= crti.o crtn.o crtbegin.o crtend.o
CLEAN_FILES+= crti.o crtn.o crtbegin.o crtend.o



#
# Compile an executable with embedded libc.
#
# To use this rule you need to first create libPROGNAME, and then
# define a PROGNAME$(EXEEXT) target.
# You also need to create a target-specific crt0.o
#
%$(EXEEXT): lib%.a crt0.o crti.o crtbegin.o crtend.o crtn.o
	$(CC) crt0.o crti.o crtbegin.o \
	$(AM_LDFLAGS) $(EC_LDFLAGS) $(LDFLAGS) \
	-Wl,--start-group $< $(AM_LDADD) -lgcc -Wl,--end-group \
	crtend.o crtn.o \
	-o $@
